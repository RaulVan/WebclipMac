# macOS WebClip 生成器技术方案

## 用户需求

- 开发一个原生 macOS 应用程序，使用 SwiftUI 框架
- 实现 WebClip 生成功能，直接创建 mobileconfig 文件
- 支持使用系统钥匙串中的 Apple 开发者证书进行签名
- 智能图片处理：自动裁剪、缩放、压缩
- 高级设置根据应用名称语言自动生成中英文内容
- 直接保存生成的文件到本地文件夹
- 专注于单一功能：WebClip 配置文件生成与签名

## 技术架构

### 1. 应用框架

- **SwiftUI**: 使用 SwiftUI 构建原生 macOS 界面
- **AppKit 集成**: 在必要时使用 AppKit 功能扩展 SwiftUI 能力
- **Security 框架**: 使用 Apple 原生 API 进行证书签名
- **Combine 框架**: 处理表单验证和用户输入

### 2. 功能模块

#### 核心模块

1. **WebClip 配置生成器**
   - 生成符合 Apple 规范的 `.mobileconfig` 配置文件
   - 处理 XML/plist 格式数据
   - 支持高级设置自定义

2. **图标处理工具**
   - 支持图片导入（PNG、JPG 格式）
   - 自动裁剪为正方形（按最短边居中裁剪）
   - 统一缩放至 256x256 像素
   - 移除透明度（Alpha 通道）
   - 压缩至 800KB 以内

3. **证书签名模块**
   - 读取系统钥匙串中的 Apple 开发者证书
   - 使用原生 Security API 进行 CMS 签名
   - 支持多种证书类型（Apple Development、Apple Distribution 等）

4. **文件操作模块**
   - 直接将生成的 `.mobileconfig` 文件保存到用户指定的本地文件夹
   - 使用 `NSSavePanel` 允许用户选择保存位置

### 3. 架构设计

采用 **MVVM** 架构:

- **Model**: WebClip 配置数据结构、证书信息结构
- **View**: SwiftUI 视图组件（ContentView、SignatureView、MainView）
- **ViewModel**: 
  - AppCoordinator: 页面导航和状态管理
  - CertificateManager: 证书管理和签名
  - MobileConfigGenerator: 配置文件生成

### 4. 用户界面

#### 主界面布局

- **顶部导航**: 分段控件切换"创建 Web Clip"和"签名"页面
- **创建页面**: 
  - WebClip 配置区域（应用名称、URL、图标）
  - 选项设置区域（可移除、全屏模式）
  - 证书签名区域（启用开关、证书选择）
  - 高级设置区域（组织名称、描述、同意信息）
  - 生成按钮
- **签名页面**: 
  - 文件选择区域
  - 证书选择区域
  - 签名按钮

#### 智能功能

1. **图片自动处理**
   - 任意尺寸图片自动处理为 256x256 正方形
   - 自动移除透明度，替换为白色背景
   - 自动压缩至 800KB 以内

2. **高级设置自动生成**
   - 检测应用名称语言（中文/英文）
   - 中文名称生成中文描述和同意信息
   - 英文名称生成英文描述和同意信息

3. **证书管理**
   - 自动读取系统钥匙串中的 Apple 开发者证书
   - 支持刷新证书列表
   - 验证证书有效性

### 5. 用户流程

#### 创建并签名 WebClip

1. 用户打开应用
2. 输入 WebClip 信息（应用名称、URL）
3. 选择或拖拽图标文件
4. 配置选项（可移除、全屏模式）
5. 启用证书签名并选择证书
6. 点击"生成并签名 WebClip"按钮
7. 选择保存位置
8. 文件保存完成

#### 为现有文件签名

1. 切换到"签名"页面
2. 选择 .mobileconfig 文件
3. 选择系统证书
4. 点击"签名"按钮
5. 选择保存位置
6. 签名文件保存完成

### 6. 配置文件格式示例

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>PayloadContent</key>
    <array>
        <dict>
            <key>FullScreen</key>
            <true/>
            <key>Icon</key>
            <data><!-- Base64编码的图标数据 --></data>
            <key>IsRemovable</key>
            <true/>
            <key>Label</key>
            <string><!-- 用户输入的标题 --></string>
            <key>PayloadDescription</key>
            <string>Configures Web Clip</string>
            <key>PayloadDisplayName</key>
            <string>Web Clip</string>
            <key>PayloadIdentifier</key>
            <string>com.example.webclip.<!-- 唯一标识符 --></string>
            <key>PayloadType</key>
            <string>com.apple.webClip.managed</string>
            <key>PayloadUUID</key>
            <string><!-- 生成的UUID --></string>
            <key>PayloadVersion</key>
            <integer>1</integer>
            <key>URL</key>
            <string><!-- 用户输入的URL --></string>
        </dict>
    </array>
    <key>PayloadDisplayName</key>
    <string><!-- 显示名称 --></string>
    <key>PayloadIdentifier</key>
    <string>com.example.<!-- 唯一标识符 --></string>
    <key>PayloadRemovalDisallowed</key>
    <false/>
    <key>PayloadType</key>
    <string>Configuration</string>
    <key>PayloadUUID</key>
    <string><!-- 生成的UUID --></string>
    <key>PayloadVersion</key>
    <integer>1</integer>
</dict>
</plist>
```

### 7. 文件结构

```
Webclip/
├── WebclipApp.swift          # 应用入口
├── ContentView.swift         # 创建 WebClip 主视图
├── View/
│   ├── MainView.swift        # 主导航视图
│   └── SignatureView.swift   # 签名视图
├── ViewModel/
│   ├── AppCoordinator.swift      # 页面导航协调器
│   ├── CertificateManager.swift  # 证书管理器
│   ├── MobileConfigGenerator.swift # 配置生成器
│   ├── MobileConfigSigner.swift  # 配置签名器
│   ├── SecCMSConfigSigner.swift  # 原生 CMS 签名器
│   ├── CMSHelper.h              # CMS 签名 OC 桥接头
│   └── CMSHelper.m              # CMS 签名 OC 实现
└── Model/
    └── WebClipModel.swift    # 数据模型
```

## 开发工具

- Xcode 14+
- Swift 5.7+
- SwiftUI 4+
- macOS 12+ (Monterey) 作为最低支持版本

## 数据流程

1. 用户通过界面输入 WebClip 配置信息
2. 图片自动处理：裁剪 → 缩放 → 移除透明度 → 压缩
3. 应用程序验证输入数据
4. 生成 mobileconfig 文件内容
5. 如启用签名，使用系统证书进行 CMS 签名
6. 弹出保存对话框让用户选择保存位置
7. 将文件写入选定位置
8. 操作完成后显示结果

## 隐私与安全

- 应用完全在本地运行，不上传任何数据
- 使用系统钥匙串中的证书，无需导入证书文件
- 不存储证书密码或敏感信息
- 符合 macOS 沙盒安全模型
